<div class="row">

  <%= render partial: 'partials/retailer_profile_nav' %>

  <div class="col s12 m8 offset-m3">

    <% if @order.product.status == 'live' %>
      <div class="col s12 m4 center-align">
        <h5><%= @order.product.time_to_expiration %></h5>
        <%= image_tag @order.product.main_image.url(:medium), :class => 'responsive-img' %>
          <h4 class='bold'><%= @order.product.title %></h4>
          <h6 class='green-text'>$<%= @order.product.discount %></h6>
          <div class="row">
            <%= form_for @order do |f| %>
              <div class="input-field">
                <%= f.label "Order Amount" %>
                <%= f.number_field :amount, :value => @order.amount %>
              </div>
            <%= f.button "Update Order", :class => 'btn' %>
            <% end %>
            <% if !flash[:error].nil? %>
              <% flash[:error].each do |err| %>
                <h6 class='red-text'><%= err %></h6>
              <% end %>
            <% end %>
          </div>
        </div>
        <div class="col s12 m8 center-align">
          <div class="row" style="padding-top: 25px">
            <h6>Upon expiration, you would be charged from this credit card:</h6>
            <h6>**** **** **** <%= @commit_card.last4 %></h6>
            <h6><%= @commit_card.brand %></h6>
            <h6>Exp: <%= @commit_card.exp_month %>/<%= @commit_card.exp_year %></h6>
          </div>
          <div class="row">
            <h6>And shipped to this address:</h6>
            <%
              EasyPost.api_key = ENV['EASYPOST_API_KEY']
              shipping_address = EasyPost::Address.retrieve(@order.shipping_address.address_id)
            %>
            <h6><%= shipping_address.street1 %></h6>
            <h6><%= shipping_address.city %>, <%= shipping_address.state %>, <%= shipping_address.zip %></h6>
          </div>
        </div>
        <div class="row order-box">
          <div class="col s6 m4 center-align">
            <% if @order.retailer.shipping_addresses.count > 1 %>
              <h6>Change Shipping Address:</h6>
              <% @order.retailer.shipping_addresses.each do |local_address| %>
                <% if local_address.id != @order.shipping_address_id %>
                <%
                EasyPost.api_key = ENV['EASYPOST_API_KEY']
                address = EasyPost::Address.retrieve(local_address.address_id)
                %>
                <div class="border">
                  <h6><%= address.street1 %></h6>
                  <h6><%= address.city %>, <%= address.state %>, <%= address.zip %></h6>
                  <form class="change-address">
                    <div class="input-field">
                      <input type="hidden" class="address-id" value="<%= local_address.id %>">
                    </div>
                    <input type="submit" value="Use Address" class='submit-link'>
                  </form>
                </div>
                <% end %>
              <% end %>
            <% end %>
          </div>
          <div class="col s6 m4 center-align">
            <% if @stripe_customer.sources.count > 1 %>
              <h6>Change payment method:</h6>
              <% @stripe_customer.sources.each do |card| %>
                <% if card.id != @order.card_id %>
                <div class="border">
                  <h6><%= card.brand %></h6>
                  <h6>**** **** **** <%= card.last4 %></h6>
                  <h6>Exp: <%= card.exp_month %>/<%= card.exp_year %></h6>
                  <form class='change-payment'>
                    <div class="input-field">
                      <input type="hidden" class='card_id' value="<%= card.id %>">
                    </div>
                    <input type='submit' class="submit-link" value="Use Card" />
                  </form>
                </div>
                <% end %>
              <% end %>
            <% end %>
          </div>
        </div>

        <div class="row order-box center-align z-depth-1">
          <form class="add-shipping">
            <div class="input-field">
              <label>Street Address One</label>
              <input class="street-line-one" type="text" name="street_one">
            </div>
            <div class="input-field">
              <label>Street Address Two</label>
              <input class="street-line-two" type="text" name="street_two">
            </div>
            <div class="input-field">
              <label>City</label>
              <input class="city" type="text" name="city">
            </div>
            <div class="input-field">
              <label>State</label>
              <input class="state" type="text" name="state">
            </div>
            <div class="input-field">
              <label>Zip</label>
              <input class="zip" type="text" name="zip">
            </div>
            <div class='errors-div'>
            </div>
            <div class="shipping-errors"></div>
            <input class="submit-address btn btn-primary" type="submit" value="New Address">
          </form>
        </div>

        <div class="row order-box center-align z-depth-1">
          <form class="credit-card-form" autocomplete="off">
            <div class="input-field">
              <label>Card Holder Name</label>
              <input id="card-name" type="text">
            </div>
            <div class="input-field">
              <label>Credit Card Number</label>
              <input id="card-number" type="text"> <br>
            </div>
            <div class="input-field">
              <label>CVC</label>
              <input id="card-cvc" type="text"> <br>
            </div>
            <div class="input-field">
              <div class="row">
                <div class="col s6 m4 offset-m2">
                  <label>Exp Month</label>
                  <input id="exp-month" type="number">
                </div>
                <div class="col s6 m4 offset-m2">
                  <label>Exp Year</label>
                  <input id="exp-year" type="number"> <br>
                </div>
              </div>
            </div>
            <div class="input-field">
              <label>Billing Zip Code</label>
              <input id="billing-zip" type="text" value="">
            </div>
            <h6 class="red-text" id="payment-errors"></h6>
            <input class="submit btn" type="submit" value="New Payment">
          </form>
        </div>

    <% else %>

      <div class="col s12 center-align">
        <div class="col s4 center-align">
          <%= image_tag @order.product.main_image.url(:medium), :class => 'responsive-img' %>
        </div>
        <div class="row">
          <h4><%= @order.product.title %></h4>
          <% if !@order.full_price %>
            <h6><%= @order.amount %> x $<%= '%.2f' % (@order.product.discount) %>: <span class='bold'>$<%= '%.2f' % (@order.amount.to_i*@order.product.discount.to_f) %></span></h6>
            <h6>Shipping: $<%= @shipping_amount %></h6>
            <hr>
            <h6 class="bold">$<%= '%.2f' % ((@order.amount.to_i*@order.product.discount.to_f)+(@shipping_amount.to_f)) %> total</h6>
          <% else %>
            <h6><%= @order.amount %> x $<%= '%.2f' % (@order.product.price) %>: <span class='bold'>$<%= '%.2f' % (@order.amountl.to_i*@order.product.price.to_f) %></span></h6>
            <h6>Shipping: $<%= @shipping_amount %></h6>
            <hr>
            <h6 class="bold">$<%= '%.2f' % ((@order.amount.to_i*@order.product.price.to_f)+(@shipping_amount.to_f)) %></h6>
          <% end %>
        </div>
        <div class="row">
          <%
            EasyPost.api_key = ENV['EASYPOST_API_KEY']
            shipping_info = EasyPost::Tracker.retrieve(@order.shipping_id)
          %>
          <h6>Tracking Code: <%= shipping_info.tracking_code %></h6>
          <h6>Estimate Delivery Date: <%= DateTime.parse(shipping_info.est_delivery_date).strftime('%B %d, %Y') %></h6>
          <h6>Currently In: <%= shipping_info.tracking_details.last.tracking_location.city %>, <%= shipping_info.tracking_details.last.tracking_location.state%> <%=shipping_info.tracking_details.last.tracking_location.zip %></h6>
          <h6><a href="<%= shipping_info.public_url %>" target="_blank">More Details</a></h6>
        </div>
      </div>
    <% end %>

  </div>

</div>

<script>
  $(document).ready(function(){
    addShippingAddress()
    addCreditCard()
    changePayment()
    changeShippingAddress()
  })

  var submittedForm;

  function addCreditCard(){
    $('.credit-card-form').submit(function(e){
      e.preventDefault()
      submittedForm = $(this)
      var cardName = submittedForm.find($('#card-name')).val();
      var cardNumber = submittedForm.find($('#card-number')).val();
      var cardCvc = submittedForm.find($('#card-cvc')).val();
      var expMonth = submittedForm.find($('#exp-month')).val();
      var expYear = submittedForm.find($('#exp-year')).val();
      var billingZip = submittedForm.find($('#billing-zip')).val()
      var submitButton = submittedForm.find($('.submit'))
      submitButton.val('Saving Card...')
      submitButton.prop('disabled', true)
      console.log(cardName + ', ' + cardNumber);
      Stripe.card.createToken({
        // customer: stripeCustomer,
        name: cardName,
        number: cardNumber,
        cvc: cardCvc,
        exp_month: expMonth,
        exp_year: expYear,
        address_zip: billingZip
      }, stripeResponseHandler);
    })
  }


function stripeResponseHandler(status, response){
  if(response.error){
    submittedForm.find('#payment-errors').text(response.error.message)
    submittedForm.find('.submit').prop("disabled", false)
    submittedForm.find('.submit').val('Add Credit Card')
  } else {
    var token = response.id;
    $.ajax({
      method: 'POST',
      url: '/api/payments/create_credit_card?token=' + token,
      success: function(data) {
        console.log(data);
        if(!data.success) {
          $('#payment-errors').text(data.error)
          submittedForm.find('.submit').prop('disabled', false)
          submittedForm.find('.submit').val('Add Credit Card')
        } else {
          changePaymentApi(data.card.id)
        }
      }
    })
  }
}

  function addShippingAddress(){
    $('.add-shipping').submit(function(e){
      e.preventDefault()
      $('.shipping-errors').text('')
      var form = $(this)
      var street_one = form.find('.street-line-one').val()
      var street_two = form.find('.street-line-two').val()
      var city = form.find('.city').val()
      var state = form.find('.state').val()
      var zip = form.find('.zip').val()
      form.find('.submit-address').prop('disabled', true)
      var params = "?street_one=" + street_one + "&street_two=" + street_two + "&city="
            + city + "&state=" + state + "&zip=" + zip
      $.ajax({
        method: 'POST',
        url: '/api/shipping/create_shipping_address' + params,
        success: function(data){
          if(data.success){
            changeShippingApi(data.local_address.id)
          } else {
            $('.submit-address').prop('disabled', false)
            for (var i = 0; i < data.errors.length; i++) {
              var error = data.errors[i]
              var errorText = $('<h6 class="red-text">').text(error.message)
              $('.shipping-errors').append(errorText)
            }
          }
        }
      })
    })
  }

  function changeShippingAddress(){
    $('.change-address').submit(function(e){
      e.preventDefault()
      var shippingId = $(this).find('.address-id').val()
      console.log(shippingId);
      changeShippingApi(shippingId)
    })
  }

  function changeShippingApi(shippingId){
    $.ajax({
      method: 'POST',
      url: '/api/shipping/change_commit_shipping?shipping_id=' +shippingId+ '&commit_id=<%= @order.id %>',
      success: function(data){
        console.log(data);
        if(data.success){
          location.reload()
        }
      }
    })
  }

  function changePayment(){
    $('.change-payment').submit(function(e){
      e.preventDefault()
      var cardId = $(this).find('.card_id').val()
      changePaymentApi(cardId)
    })
  }

  function changePaymentApi(cardId){
    $.ajax({
      method: 'POST',
      url: '/api/payments/change_commit_card?card_id=' +cardId+ '&commit_uuid=<%= @order.uuid %>',
      success: function(data){
        console.log(data);
        if(data.success){
          location.reload()
        }
      }
    })
  }
</script>
