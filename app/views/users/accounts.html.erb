<%= button_to "Log Out", sessions_path, method: :delete %>
<%= button_to "Profile", retailer_path, method: :get %>
<%= button_to "Shop", shop_path, method: :get %>

<h1>Hello <%= current_user.email %></h1>

<div class="text-center">
  <h3>Make a test charge on credit card:</h3>
  <button id="test-charge">Charge me $1.00</button>
</div>

<script>
  $('#test-charge').click(function(){
    var xhttp = new XMLHttpRequest()
    xhttp.open("GET", "/api/charge_credit_card", true);
    xhttp.send();
    location.reload();
    // location.reload();
  })
</script>


<% if @stripe_customer.default_source.nil? %>
  <div class="text-center">
    <h3>You need your payment info!</h3>
    <!-- <input id="stripe-customer" type="hidden" value="<%=current_user.stripe_customer_id %>"> -->
    <label>Card Holder Name</label>
    <input id="card-name" type="text" value="" placeholder="John Smith">
    <label>Credit Card Number</label>
    <input id="card-number" type="text" value="" placeholder="**** **** **** ****"> <br>
    <label>CVC</label>
    <input id="card-cvc" type="text" value="" placeholder="123"> <br>
    <label>Exp Month</label>
    <input id="exp-month" type="number" value="" placeholder="01">
    <label>Exp Year</label>
    <input id="exp-year" type="number" value="" placeholder="2020"> <br>
    <label>Billing Zip Code</label>
    <input id="billing-zip" type="text" value="">
    <span id="payment-errors"></span> <br>
    <button id="create-card" name="button">Add Credit Card</button>
  </div>
<% else %>
  <div class="row">
    <% @stripe_customer.sources.each do |source| %>
      <div class="row text-center border col-xs-6 col-xs-offset-3">
        <h2>Card Holder: <%= source.name %></h2>
        <h3>Card Number: **** **** **** <%= source.last4 %></h3>
        <h3> Zip: <%= source.address_zip %></h3>
        <h3>Expiration: <%= source.exp_month %>/<%= source.exp_year %> </h3>
      </div>
    <% end %>
  </div>
  <div class="text-center row">
    <h3>Add another form of payment</h3>
    <!-- <input id="stripe-customer" type="hidden" value="<%=current_user.stripe_customer_id %>"> -->
    <div class="row">
      <label>Card Holder Name</label>
      <input id="card-name" type="text" value="" placeholder="John Smith">
    </div>
    <div class="row">
      <label>Credit Card Number</label>
      <input id="card-number" type="text" value="" placeholder="**** **** **** ****">
    </div>
    <div class="row">
      <label>CVC</label>
      <input id="card-cvc" type="text" value="" placeholder="123">
    </div>
    <div class="row">
      <label>Expiration</label>
      <input id="exp-month" type="number" value="" placeholder="01"> / <input id="exp-year" type="number" value="" placeholder="2020">
    </div>
    <div class="row">
      <label>Billing Zip Code</label>
      <input id="billing-zip" type="text" value="" placeholder ="12345">
    </div>
    <div class="row">
      <span id="payment-errors"></span>
    </div>
    <div class="row">
      <button id="create-card" name="button">Add Credit Card</button>
    </div>
  </div>
<% end %>

<script>
  $('#create-card').click(function(){
      $("create-card").prop("disabled", true)
      $(this).text('One moment...')
      // var stripeCustomer = $('#stripe-customer').val();
      var cardName = $('#card-name').val();
      var cardNumber = $('#card-number').val();
      var cardCvc = $('#card-cvc').val();
      var expMonth = $('#exp-month').val();
      var expYear = $('#exp-year').val();
      var billingZip = $('#billing-zip').val()
      Stripe.card.createToken({
        // customer: stripeCustomer,
        name: cardName,
        number: cardNumber,
        cvc: cardCvc,
        exp_month: expMonth,
        exp_year: expYear,
        address_zip: billingZip
      }, stripeResponseHandler);
  })

  function stripeResponseHandler(status, response){
    if(response.error){
      $('#payment-errors').text(response.error.message)
      $('#create-card').prop("disabled", false)
    } else {
      var token = response.id;
      console.log(token);
      var xhttp = new XMLHttpRequest()
      // xhttp.onreadystatechange = function() {
      //   if (xhttp.readyState == 4 && xhttp.status == 200) {
      //     var json = JSON.parse(xhttp.responseText);
      //   }
      // }
      xhttp.open("GET", "/api/create_credit_card/" + token, true);
      xhttp.send();
      location.reload();
    }
  }
</script>
