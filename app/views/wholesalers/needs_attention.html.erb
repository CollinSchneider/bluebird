
<div class="container center-align">
  <h4>Needs Attention</h4>

  <h6 id="notice"></h6>

  <% @products.each_slice(3) do |slice| %>
    <div class="row">
      <% slice.each do |product| %>
        <div class="border col s4 center-align product">

          <h5>Expired at <%= product.calc_end_time %></h5>
          <h4><%= product.title %></h4>
          <%= image_tag product.main_image, :class => 'responsive-img' %>
          <h5 class="was-price">Was $<%= product.price %></h5>
          <h4>Now $<%= product.discount %></h4>
          <h5><%= product.description %></h5>

          <% total_orders = Commit.where('product_id = ?', product.id).sum(:amount).to_i %>
          <% total_sales = total_orders*product.discount.to_f %>
          <% real_percentage = ((total_sales/product.milestones[0].goal.to_i)*100) %>
          <% if real_percentage >= 100 %>
            <% percentage = 100 %>
          <% end %>
          <h4>$<%= '%.2f' % total_sales %> in sales</h4>
          <h5>Completed <%= '%.2f' % real_percentage %>% of your goal</h5>

          <% if total_sales > 0 %>
            <button class='grant-discount btn' data='<%= product.id %>'>Grant Discount</button>
          <% end %>
          <button class='expire-product btn green' data='<%= product.id %>'>Expire Product</button>

          <!-- <div class="progress-bar-outline col s8 offset-s2 no-padding">
            <div class="progress-fill no-margin" style="width: <%= percentage %>%">
            </div>
          </div> -->
        </div>
      <% end %>
    </div>
  <% end %>

</div>

<script>
  $('.grant-discount').click(function(){
    var div = $(this).parent()
    var productId = $(this).attr('data')
    $.ajax({
      url: '/api/grant_discount?product_id=' + productId,
      success: function(data) {
        console.log(data);
        $('#notice').text("You have successfully granted the discount to " + data.product.title + ", you must now ship it out and the funds will be transferred to your account (see your profile page)!")
        div.remove()
      }
    })
  })

  $('.expire-product').click(function(){
    var div = $(this).parent()
    var productId = $(this).attr('data')
    $.ajax({
      url: '/api/expire_product?product_id=' + productId,
      success: function(data) {
        console.log(data);
        $('#notice').text("You have successfully expired the product " + data.product.title + ", you are no longer guaranteed any sales.")
        div.remove()
      }
    })
  })
</script>
