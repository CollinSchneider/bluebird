<%= button_to "Logout", sessions_path, method: :delete %>
<%= button_to "Shop", shop_path, method: :get %>


<h1 class="text-center">Hello <%= current_user.email %> Wholesaler!</h1>


<% if @current_batch %>
  <div class="text-center">
    <h3>You currently do not have a batch in process, would you like to start one?</h3>
    <div id="new-batch" class="border:1px solid black; text-align: center">
      <%= form_for Batch.new do |f| %>
        <%= f.hidden_field :user_id, :value => current_user.id %>
        <%= f.label :duration %>
        <%= f.select :duration, :required => true do %>
          <% ['1 Day', '7 Days', '30 Days'].each do |a| %>
            <%= content_tag(:option, a, value: a,) %>
            <!-- Ends duration array -->
          <% end %>
          <!-- Ends select -->
        <% end %>
        <%= f.submit "Create New Batch!" %>
        <!-- Ends Form -->
      <% end %>
      <button id="cancel-batch" type="button">Cancel</button>
    </div>
    <button id="start-batch" type="button">Start New Batch</button>
  </div>
<% else %>
  <h3>You have a batch currently on sale </h3>
  <% current_user.batches.each do |batch| %>
    <h4> This batch will expire at <%= batch.end_time.strftime('%l:%M %P') %> on <%= batch.end_time.strftime('%B %d, %Y') %></h4>
    <% batch.products.each do |product| %>
      <div style="border:1px solid black">
        <div class="row">
          <div class="col-xs-3">
            <img src="/images/placeholder.png" alt="" />
          </div>
          <div class="col-xs-9">

          <h2><%= product.title %></h2>
          <h3>Original Wholesale Price: $<%= product.price %></h3>
          <h3>Offered Discount Price: $<%= product.discount %></h3>
          <h3>You have set a goal to sell <%= product.batch.milestones[0].goal %> products in this batch</h3>
          <% total_commit_amount = 0 %>
          <% product.commits.each do |commit| %>
            <% total_commit_amount += commit.amount.to_i %>
          <% end %>
          <h3>You have sold <%= total_commit_amount %> products so far in a timeframe of <%= (Time.now - product.batch.start_time) %> seconds (CONVERT LATER)</h3>
          <h4>This amounts to $<%= total_commit_amount * product.discount.to_i %> in revenue at the discounted price</h4>
        </div>
        </div>
      </div>
    <% end %>
  <% end %>
<!-- Ends if batches.length == 0 -->
<% end %>

<h1 class="text-center">Past Batches:</h1>
<% @past_batches.each do |past_batch| %>
  <% if past_batch.completed_status.nil? %>
    <% total_sales = 0 %>
    <% past_batch.products.each do |product| %>
      <% product.commits.each do |commit| %>
        <% total_sales += commit.amount.to_i*commit.product.price.to_i %>
      <% end %>
    <% end %>
    <div class="row text-center">
      <h3>Batch for: <%= past_batch.time_frame(past_batch.start_time, past_batch.end_time) %></h3>
      <h3>Set a goal of $<%= past_batch.milestones[0].goal %> in sales </h3>
      <h3>You reached $<%= total_sales %> in sales</h3>
    </div>
    <% past_batch.products.each do |product| %>
      <div class="col-xs-6 text-center border">
        <h4><%= product.title %></h4>
        <h4> Original Wholesale Price: $<%= product.price %></h4>
        <h4> Potential Discount Price: $<%= product.discount %></h4>
        <% product_sales = 0 %>
        <% product.commits.each do |commit| %>
          <% product_sales += commit.amount.to_i*commit.product.discount.to_i %>
        <% end %>
        <h5> Total Purchase Orders: <%= product_sales %> </h5>
      </div>
      <!-- Closes products.each -->
    <% end %>
    <div class="col-xs-12 text-center row">
      <!-- If you didn't reach your goal -->
      <% if total_sales < past_batch.milestones[0].goal.to_i %>
        <button id="cancel-batch-button" data="<%= past_batch.id %>" type="button">Cancel Batch</button>
        <button id="grant-discount" data="<%= past_batch.id %>" type="button">Give Discount</button>
      <!-- If you did reach your goal -->
      <% else %>
        <h4>Congrats, you reached your goal of <%= past_batch.milestones[0].goal %>!</h4>
        <!-- Mark batch as goal reached -->
        <%
          past_batch.completed_status = 'goal_reached'
          past_batch.save
        %>
      <% end %>
    </div>
  <% else %>
    <div class="col-xs-6 border text-center">
      <h4>Batch for <%= past_batch.time_frame(past_batch.start_time, past_batch.end_time) %></h4>
      <% completed_status =  past_batch.completed_status.gsub("_", " ").split(" ") %>
      <h4> <%= completed_status[0].capitalize %> <%= completed_status[1].capitalize %> </h4>
      <% batch_orders = 0 %>
      <% batch_revenue = 0 %>
      <% past_batch.products.each do |product| %>
        <% product.commits.each do |commit| %>
          <% batch_orders += commit.amount.to_i %>
          <% batch_revenue += (commit.amount.to_i*commit.product.discount.to_i) %>
        <% end %>
      <% end %>
      <h4> Set a goal of <%= past_batch.milestones[0].goal %> orders </h4>
      <h4> Made $<%= batch_revenue %> in sales</h4>
    </div>
  <!-- Closes if past_batch.completed_status.nil? -->
  <% end %>
  <!-- Closes past_batches.each -->
<% end %>

<script>
  $('#cancel-batch-button').click(function(){
    var batchId = $(this).attr('data');
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function(){
      if(xhttp.readyState == 4 && xhttp.status == 200){
        JSON.parse(xhttp.responseText);
      }
    }
    xhttp.open("GET", "/batches/" + batchId + "/cancel_batch");
    xhttp.send();
    location.reload();
  })

  $('#grant-discount').click(function(){
    var batchId = $(this).attr('data');
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function(){
      if(xhttp.readyState == 4 && xhttp.status == 200){
        JSON.parse(xhttp.responseText);
      }
    }
    xhttp.open("GET", "/batches/" + batchId + "/grant_discount");
    xhttp.send();
    location.reload();
  })

  $('#start-batch').click(function(){
    console.log('click');
    $('#new-batch').toggle();
    $('#start-batch').toggle();
  })
  $('#cancel-batch').click(function(){
    $('#start-batch').toggle();
    $('#new-batch').toggle();
  })
</script>
