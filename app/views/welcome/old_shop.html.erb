<div id="product" class="col-xs-12 col-sm-3 no-padding text-center">
  <h2><%= link_to product.title, product_path(product.id) %></h2>
  <h3>$<%= product.discount %> (<%= '%.2f' % (100*(1 - (product.discount.to_f/product.price.to_f))) %>% discount) </h3>
  <!-- <h4><#%= product.description %></h4> -->
  <div class="col-xs-12 no-padding no-margin">
    <%= image_tag product.main_image.url(:medium), :class => "responsive-img" %>
    <!-- <img class="responsive-img" src="/images/placeholder.png" alt="" /> -->
  </div>

    <h4>Expires at <%= product.batch.end_time.strftime('%l:%M %P') %> on <%= product.batch.end_time.strftime('%B %d, %Y') %></h4>
    <!-- <div class="col-xs-12 text-right" style="padding: 0 0 0 0">
      <h6><%= product.batch.milestones[0].goal %> products <span class="glyphicon glyphicon-arrow-up"/></h6>
    </div> -->
  <!-- </div> -->
    <br>
  <% if product.batch.user.email == current_user.email %>
    <h4>Your product!</h4>
  <% else %>
    <h4>Product for sale by: <%= link_to product.batch.user.email, batch_path(product.batch.id) %> </h4>
  <% end %>
  <% milestone_goal = nil %>
  <% product.milestones.each do |milestone| %>
    <h5>Goal: $<%= milestone_goal = milestone.goal %></h5>
  <% end %>
  <% total_commit_amount = 0 %>
  <% product.product_items.each do |item| %>
    <% item.commits.each do |commit| %>
      <% total_commit_amount += commit.amount.to_i %>
    <% end %>
  <% end %>
  <% product.product_items.each do |item| %>
    <h4><%= item.description %>: <%= item.quantity %></h4>
    <% if current_user.user_type == 'retailer' %>
      <% users_commit = Commit.where('user_id = ? AND product_item_id = ?', current_user.id, item.id) %>
        <% if users_commit != [] %>
          <h3 style="border-top:1px solid black"> <span class="glyphicon glyphicon-ok-circle"></span> <%= link_to "#{users_commit[0].amount} purchase orders", commit_path(users_commit[0].id) %> </h3>
        <% else %>
        <% if @stripe_customer.default_source %>
          <input type="text" placeholder="<%= item.description %> <%= item.product.title %>">
          <!-- <#%= form_for Commit.new do |f| %>
            <#%= f.hidden_field :product_item_id, :value => item.id %>
            <#%= f.hidden_field :user_id, :value => current_user.id %>
            <#%= f.label "Purchase Order Quantity" %>
            <#%= f.number_field :amount %> <br>
            <#%= f.button "Make Order" %>
          <#% end %> -->
        <% else %>
        <!-- Button trigger modal -->
        <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">
          Make Purchase Order
        </button>

        <!-- Modal -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Add Payment Info</h4>
              </div>
              <div class="modal-body">
                <div class="text-center">
                  <div class="row">
                    <label>Card Holder Name</label>
                    <input id="card-name" type="text" value="" placeholder="John Smith">
                  </div>
                  <div class="row">
                    <label>Credit Card Number</label>
                    <input id="card-number" type="text" value="" placeholder="**** **** **** ****"> <br>
                  </div>
                  <div class="row">
                    <label>CVC</label>
                    <input id="card-cvc" type="text" value="" placeholder="123"> <br>
                  </div>
                  <div class="row">
                    <label>Exp Month</label>
                    <input id="exp-month" type="number" value="" placeholder="01">
                  </div>
                  <div class="row">
                    <label>Exp Year</label>
                    <input id="exp-year" type="number" value="" placeholder="2020"> <br>
                  </div>
                  <div class="row">
                    <label>Billing Zip Code</label>
                    <input id="billing-zip" type="text" value="" placeholder ="12345">
                  </div>
                  <div class="row">
                    <span id="payment-errors"></span> <br>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button data="<%=product.id%>" class="create-credit-card btn btn-primary">Save Credit Card</button>
              </div>
            </div>
          </div>
        </div>
        <!-- Closes users_commit if -->
      <% end %>
    <% end %>
  <% end %>

  <h4> <%= total_commit_amount %> orders on this product </h4>
  <% percent_there = ('%.3f' % (total_commit_amount.to_f/product.batch.milestones[0].goal.to_i.to_f)) %>
  <!-- <h4> We're only <#%= '%.2f' % total_commit_amount.to_i/product.batch.milestones[0].goal.to_i %>% away from your deal! </h4> -->
    <!-- Closes if user == retailer -->
  <% end %>
</div>
